<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Worked example from lecture notes</title>
		<style>
			#bcanvas, #fcanvas
			{
				border:1px solid black;
				left: 5px;
				top: 5px;
				position: absolute;
			}
			


			#loadingMessage
			{
				position:absolute;
				top:100px;
				left:100px;
				z-index:100;
				font-size:50px;
			}
			

		</style>
		<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
	</head>

	<body>
		<canvas id = "bcanvas" style = "z-index: 0">
			Your browser does not support the HTML5 'Canvas' tag.
			
		</canvas>
		<br>
		<canvas id = "fcanvas" style = "z-index: 1">
			Your browser does not support the HTML5 'Canvas' tag.
		</canvas>
	</body>
</html> 


<script src = "objects.js"></script>
<script>


// Canvas & Context
// Foreground Canvas
var forecanvas;
var fctx;
// Background Canvas
var backcanvas;
var bctx;
// Main Canvas
var maincanvas
var mctx;

/**
*	Game State Variables
**/
	// Array of NPCs and PC
	var characters = [];
	// Array of bullets
	var projectiles = [];
	// Player Object
	var player;
	var playerName;
	var round = 1;
/**
*
**/
var singlefireInterval = null;
var automaticInterval = null;

// Constants
var CANVAS_WIDTH = 510;
var CANVAS_HEIGHT = 510;

var mouseX;
var mouseY;

// Tile Data
 var mapData = 
	[
		[2, 2, 2, 2, 2, 2, 2, 2],
		[2, 2, 2, 2, 2, 2, 2, 2],
		[2, 1, 1, 1, 2, 2, 0, 2],
		[2, 2, 2, 2, 2, 2, 2, 2],
		[2, 2, 0, 2, 2, 2, 2, 2],
		[2, 2, 2, 2, 1, 1, 2, 2],
		[1, 1, 1, 2, 2, 2, 2, 2],
		[2, 2, 2, 2, 2, 2, 2, 2]
	];

var tileset = new Image();
tileset.src = 'images/tileset_64.png';
	
var projectile = new Image();
projectile.src = 'images/bullet.png';

var tileSize = 64;       // The size of a tile (32Ã—32)
var imageNumTiles = 2;  // The number of tiles per row in the tileset image

var map = []; // Holds information on pressed keys
var mouseMap = []; // Holds information on mouse clicks
var weapons = []; // Holds paths for weapon soundfiles

window.onload = onAllAssetsLoaded;
document.write("<div id='loadingMessage'>Loading...</div>");

// On load
function onAllAssetsLoaded(){
    document.getElementById('loadingMessage').style.visibility = "hidden";

	
    forecanvas = document.getElementById("fcanvas");
    fctx = forecanvas.getContext("2d");
	
	backcanvas = document.getElementById("bcanvas");
    bctx = backcanvas.getContext("2d");
	
 
	gameSetup();
}

function gameSetup(){
	canvasSetup();
	tilesetSetup();
	weaponSetup();
	roundSetup();
	renderBackground();
	renderForeground();
	inputSetup();
}

function canvasSetup(){
	forecanvas.width = CANVAS_WIDTH;
    forecanvas.height = CANVAS_HEIGHT;
	backcanvas.width = CANVAS_WIDTH;
    backcanvas.height = CANVAS_HEIGHT;
}

function weaponSetup(){
	pistol = new Weapon(.15, 34, 1, 0, false, 'sounds/weapons/pistol-mike_koenig.mp3');
	shotgun = new Weapon(.90, 100, 5, 3, true, 'sounds/weapons/shotgun-the_sun_god.mp3');
	assault = new Weapon(.10, 40, 1, 0, true, 'sounds/weapons/pistol-mike_koenig.mp3');
}

function tilesetSetup(){
	
}

function roundSetup(){
	renderCanvasInterval = setInterval(update, 5);  // game loop
	spawnPlayer();
	spawnZombies();
}

function spawnPlayer(){
	player = new Player(4,4,tileSize/2,tileSize/2);
	characters.push(player);
}

function spawnZombies(){
	zombie1 = new Zombie(3,3,tileSize/2,tileSize/2,5);
	characters.push(zombie1);
	zombie2 = new Zombie(5,2,32,32,5);
	characters.push(zombie2);
}


function renderBackground(){
	bctx.clearRect(0, 0, backcanvas.width, backcanvas.height);
	for(var x = 0; x < mapData.length; x++){
		for(var y = 0; y < mapData[0].length; y++){
				var tile = mapData[x][y];
				var tileRow = (tile / imageNumTiles) | 0; // Bitwise OR operation
				var tileCol = (tile % imageNumTiles) | 0;
				
				bctx.drawImage(tileset, 
							 (tileCol * tileSize), 
							 (tileRow * tileSize), 
							 tileSize, 
							 tileSize, 
							 (x * tileSize), 
							 (y * tileSize), 
							 tileSize, 
							 tileSize);
		}
	}
}

function renderForeground(){
	fctx.clearRect(0, 0, forecanvas.width, forecanvas.height);
	
	// Draws all characters on foreground canvas
	for(i = 0; i < characters.length; i++){
		characters[i].draw();
	}
	// Draws all projectiles on foreground canvas
	for(i = 0; i < projectiles.length; i++){
		projectiles[i].draw();
	}

}

function inputSetup(){
	onkeydown = onkeyup = function(e){
		e = e || event; // to deal with IE
		map[e.which] = e.type == 'keydown';
		if(e.which == 49){
			player.setWeapon(pistol);
		}
		if(e.which == 50){
			player.setWeapon(shotgun);
		}
		if(e.which == 51){
			player.setWeapon(assault);
		}
		
	}
	
	onmousemove = function(e){
		mouseX = e.clientX;
		mouseY = e.clientY;
	}
		
	onmousedown = onmouseup = function(e){
		e = e || event; // to deal with IE
		mouseMap[e.which] = e.type == 'mousedown';
		player.checkShoot();
	}
}

function update(){
	// Updates next xy of all characters
	for(i = 0; i < characters.length; i++){
		characters[i].move();
		if(characters[i].getDead()){
			characters[i] = null;
			characters.splice(i, 1);
		}
	}
	// Updates next xy of projectile
	for(i = 0; i < projectiles.length; i++){
		projectiles[i].move();
		// Removes bullets that have hit targets
		if(projectiles[i].getHit()){
			projectiles.splice(i, 1);
		}
	}
	renderForeground();
}

	



</script>